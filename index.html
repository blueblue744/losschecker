<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Loss Checker</title>
    
    <!-- PWA / Icon Settings -->
    <link rel="icon" type="image/png" href="https://placehold.co/64x64/0284c7/ffffff.png?text=LC&font=roboto" />
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/0284c7/ffffff.png?text=LC&font=roboto" />
    
    <!-- Embedded Manifest for PWA Support -->
    <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22Loss%20Checker%22%2C%22short_name%22%3A%22LossChecker%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23ffffff%22%2C%22theme_color%22%3A%22%230284c7%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fplacehold.co%2F192x192%2F0284c7%2Fffffff.png%3Ftext%3DLC%26font%3Droboto%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fpng%22%7D%2C%7B%22src%22%3A%22https%3A%2F%2Fplacehold.co%2F512x512%2F0284c7%2Fffffff.png%3Ftext%3DLC%26font%3Droboto%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D" />
    
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="theme-color" content="#0284c7" />
    <meta name="msapplication-TileColor" content="#0284c7" />
    <meta name="msapplication-TileImage" content="https://placehold.co/144x144/0284c7/ffffff.png?text=LC&font=roboto" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ZXing Library for Barcode Scanning -->
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
    
    <!-- Babel for React/TypeScript compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind Configuration -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                50: '#f0f9ff',
                100: '#e0f2fe',
                500: '#0ea5e9',
                600: '#0284c7',
                900: '#0c4a6e',
              }
            },
            animation: {
              scan: 'scan 2s linear infinite',
            },
            keyframes: {
              scan: {
                '0%': { top: '0%', opacity: '0' },
                '10%': { opacity: '1' },
                '90%': { opacity: '1' },
                '100%': { top: '100%', opacity: '0' },
              }
            }
          }
        }
      }
    </script>
    <style>
      /* Hide scrollbar for clean mobile UI */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
    
    <!-- Import Map for React & Icons -->
    <script type="importmap">
    {
      "imports": {
        "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0",
        "react": "https://aistudiocdn.com/react@^19.2.0",
        "react/": "https://aistudiocdn.com/react@^19.2.0/",
        "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
        "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client"
      }
    }
    </script>
  </head>
  <body class="bg-gray-50 text-gray-900 antialiased">
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-presets="env,react,typescript" data-type="module">
      import React, { useState, useEffect, useMemo, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import { Trash2, Camera, Download, Upload, FileJson, Settings, TrendingUp, Database, Search, Plus, Tag, ChevronLeft, ChevronRight, List, X, Info, RotateCcw } from 'lucide-react';

      // ----------------------------------------------------------------------
      // TYPES & ENUMS
      // ----------------------------------------------------------------------

      // In TypeScript, these would be separate files, but we merge them here.
      
      const RecordType = {
        WASTE: 'waste',
        MARKDOWN: 'markdown'
      };

      // Interfaces are used by Babel's TS preset for type checking (if enabled) but stripped for runtime.
      /*
      interface Product {
        barcode: string;
        name: string;
      }
      interface LossRecord {
        id: string;
        barcode: string;
        productName: string;
        originalPrice: number;
        markdownPrice?: number;
        quantity: number;
        type: string; // RecordType
        timestamp: number;
        dateStr: string;
      }
      interface StoreProfile {
        storeName: string;
        storeNumber: string;
        departmentNumber?: string;
        instorePrefixes?: string;
        instoreItemCodeLength?: number;
      }
      */

      // ----------------------------------------------------------------------
      // UTILS
      // ----------------------------------------------------------------------

      const getFiscalMonthLabel = (date) => {
        const day = date.getDate();
        let month = date.getMonth() + 1; // 0-indexed to 1-indexed
        let year = date.getFullYear();

        // If we are on or after the 21st, we belong to the NEXT month's fiscal period
        if (day >= 21) {
          month++;
          if (month > 12) {
            month = 1;
            year++;
          }
        }

        // Pad month with zero (e.g., 4 -> 04) to ensure correct string sorting
        const monthStr = String(month).padStart(2, '0');

        return `${year}年${monthStr}月度`;
      };

      const filterRecordsByFiscalMonth = (records, fiscalLabel) => {
        return records.filter(r => getFiscalMonthLabel(new Date(r.timestamp)) === fiscalLabel);
      };

      const formatCurrency = (amount) => {
        return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(amount);
      };

      const downloadCSV = (content, filename) => {
        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
        const blob = new Blob([bom, content], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        window.URL.revokeObjectURL(url);
      };

      /**
       * Parses Japanese Instore Codes (Non-PLU).
       * Format: 13 digits, FF C... P... D
       */
      const parseInstoreCode = (code, allowedPrefixes = [], itemCodeLength = 5) => {
        if (code.length !== 13) {
          return null;
        }

        const prefix = code.substring(0, 2);
        
        // Check if prefix is in the allowed list
        if (!allowedPrefixes.includes(prefix)) {
          return null;
        }

        // Calculate split points based on configured length
        const itemCodeEndIndex = 2 + itemCodeLength;
        const itemCode = code.substring(2, itemCodeEndIndex);
        
        // Price is from end of ItemCode up to 12 (last digit is CD)
        const pricePart = code.substring(itemCodeEndIndex, 12);
        const price = parseInt(pricePart, 10);

        return {
          prefix,
          itemCode,
          price
        };
      };

      // ----------------------------------------------------------------------
      // SCANNER COMPONENT
      // ----------------------------------------------------------------------

      const Scanner = ({ onDetected, onClose }) => {
        const videoRef = useRef(null);
        const codeReaderRef = useRef(null);
        const [error, setError] = useState('');
        const [isInitializing, setIsInitializing] = useState(true);

        useEffect(() => {
          let stream = null;

          const startScanner = async () => {
            try {
              // ZXing configuration hints
              const hints = new Map();
              // @ts-ignore
              const formats = [ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.EAN_8];
              // @ts-ignore
              hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
              
              // @ts-ignore
              const codeReader = new ZXing.BrowserMultiFormatReader(hints);
              codeReaderRef.current = codeReader;

              // Acquire camera stream explicitly
              const constraints = {
                video: {
                  facingMode: 'environment',
                  width: { ideal: 1280 },
                  height: { ideal: 720 }
                }
              };

              stream = await navigator.mediaDevices.getUserMedia(constraints);
              
              if (videoRef.current) {
                videoRef.current.srcObject = stream;
                // Use decodeFromStream to pass the active stream to ZXing
                await codeReader.decodeFromStream(stream, videoRef.current, (result, err) => {
                  if (result) {
                    onDetected(result.getText());
                    codeReader.reset();
                  }
                });
                setIsInitializing(false);
              }
            } catch (err) {
              console.error("Scanner Error:", err);
              let msg = "カメラを起動できませんでした。";
              if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                msg = "カメラのアクセス権限がありません。設定を確認してください。";
              } else if (err.name === 'NotFoundError') {
                 msg = "カメラが見つかりません。";
              }
              setError(msg);
              setIsInitializing(false);
            }
          };

          startScanner();

          return () => {
            if (codeReaderRef.current) {
              codeReaderRef.current.reset();
            }
            if (stream) {
              stream.getTracks().forEach(track => track.stop());
            } else if (videoRef.current && videoRef.current.srcObject) {
               const videoStream = videoRef.current.srcObject;
               videoStream.getTracks().forEach(track => track.stop());
            }
          };
        }, [onDetected]);

        return (
          <div className="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center overflow-hidden">
            <video 
              ref={videoRef} 
              className="absolute inset-0 w-full h-full object-cover"
              playsInline 
              muted
            />

            {/* Visual Guide Overlay */}
            <div className="absolute inset-0 z-10 flex items-center justify-center">
               <div className="absolute inset-0 border-[100vmax] border-black/50 box-content pointer-events-none"></div>
               <div className="w-64 h-40 border-2 border-white/90 rounded-lg relative shadow-lg z-20 overflow-hidden">
                  <div className="absolute top-0 left-0 w-4 h-4 border-t-4 border-l-4 border-brand-500"></div>
                  <div className="absolute top-0 right-0 w-4 h-4 border-t-4 border-r-4 border-brand-500"></div>
                  <div className="absolute bottom-0 left-0 w-4 h-4 border-b-4 border-l-4 border-brand-500"></div>
                  <div className="absolute bottom-0 right-0 w-4 h-4 border-b-4 border-r-4 border-brand-500"></div>
                  <div className="absolute top-0 left-0 w-full h-0.5 bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.8)] animate-scan"></div>
               </div>
            </div>

            {isInitializing && (
              <div className="absolute inset-0 flex items-center justify-center bg-black z-30 text-white">
                <p className="animate-pulse">カメラ起動中...</p>
              </div>
            )}

            <div className="absolute top-10 left-0 right-0 z-20 text-center pointer-events-none">
               <div className="bg-black/60 text-white inline-block px-6 py-2 rounded-full backdrop-blur-md shadow-lg text-sm font-medium">
                 バーコードを枠に合わせてください
               </div>
            </div>

            {error && (
              <div className="absolute inset-0 z-40 flex items-center justify-center bg-black/90 p-6">
                  <div className="bg-gray-800 p-6 rounded-xl text-center shadow-2xl max-w-xs w-full border border-gray-700">
                    <p className="text-white font-bold mb-6">{error}</p>
                    <button onClick={onClose} className="w-full py-3 bg-gray-600 hover:bg-gray-500 text-white rounded-lg font-bold transition-colors">
                      閉じる
                    </button>
                  </div>
              </div>
            )}

            <div className="absolute bottom-10 left-0 right-0 z-20 flex justify-center px-4">
              <button onClick={onClose} className="px-8 py-3 bg-white/10 hover:bg-white/20 text-white border border-white/30 rounded-full font-bold backdrop-blur-md shadow-lg transition-all active:scale-95">
                キャンセル
              </button>
            </div>
          </div>
        );
      };

      // ----------------------------------------------------------------------
      // APP COMPONENT
      // ----------------------------------------------------------------------

      // Helper to get YYYY-MM-DD in local time
      const getTodayStr = () => {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
      };

      const App = () => {
        // --- State ---
        const [storeProfile, setStoreProfile] = useState({ 
          storeName: '', 
          storeNumber: '', 
          departmentNumber: '',
          instorePrefixes: '20,21,22,23,24,25,26,27,28,29',
          instoreItemCodeLength: 5 
        });
        const [records, setRecords] = useState([]);
        const [products, setProducts] = useState([]);
        
        // Input Form State
        const [inputDate, setInputDate] = useState(getTodayStr());
        const [barcode, setBarcode] = useState('');
        const [productName, setProductName] = useState('');
        const [price, setPrice] = useState('');
        const [type, setType] = useState(RecordType.WASTE);
        const [markdownPrice, setMarkdownPrice] = useState('');
        const [quantity, setQuantity] = useState('1');
        
        // UI State
        const [scannerTarget, setScannerTarget] = useState(null); // 'main' | 'db' | null
        const [showNoJanModal, setShowNoJanModal] = useState(false);
        const [activeTab, setActiveTab] = useState('input');
        
        // Modals
        const [deleteConfirm, setDeleteConfirm] = useState({ show: false, type: null, id: '' });
        const [importConfirm, setImportConfirm] = useState({ show: false, products: [] });
        const [restoreConfirm, setRestoreConfirm] = useState({ show: false, data: null });
        const [resetConfirm, setResetConfirm] = useState(false);
        
        // Database Tab
        const [dbSearch, setDbSearch] = useState('');
        const [newProductBarcode, setNewProductBarcode] = useState('');
        const [newProductName, setNewProductName] = useState('');

        // Report Tab
        const [viewMonth, setViewMonth] = useState('');

        // --- Effects ---
        useEffect(() => {
          const savedProfile = localStorage.getItem('lc_profile');
          const savedRecords = localStorage.getItem('lc_records');
          const savedProducts = localStorage.getItem('lc_products');
          
          if (savedProfile) {
            const parsed = JSON.parse(savedProfile);
            setStoreProfile(prev => ({ 
              ...prev, 
              ...parsed,
              instoreItemCodeLength: parsed.instoreItemCodeLength ?? 5 
            }));
          }
          if (savedRecords) setRecords(JSON.parse(savedRecords));
          if (savedProducts) setProducts(JSON.parse(savedProducts));
          
          setViewMonth(getFiscalMonthLabel(new Date()));
        }, []);

        useEffect(() => {
          localStorage.setItem('lc_records', JSON.stringify(records));
        }, [records]);

        useEffect(() => {
          localStorage.setItem('lc_profile', JSON.stringify(storeProfile));
        }, [storeProfile]);

        useEffect(() => {
          localStorage.setItem('lc_products', JSON.stringify(products));
        }, [products]);

        // Auto-fill Product Name & Handle Instore Codes
        useEffect(() => {
          if (!barcode) {
            setProductName('');
            return;
          }

          const prefixes = storeProfile.instorePrefixes 
            ? storeProfile.instorePrefixes.split(',').map(s => s.trim()).filter(s => s !== '')
            : [];
          
          const cLen = storeProfile.instoreItemCodeLength || 5;
          const instoreInfo = parseInstoreCode(barcode, prefixes, cLen);
          
          if (instoreInfo) {
            setPrice(instoreInfo.price.toString());
            const pLen = 10 - cLen;
            const zeroPadding = '0'.repeat(pLen + 1);
            const lookupCode = instoreInfo.prefix + instoreInfo.itemCode + zeroPadding;
            
            const found = products.find(p => p.barcode === lookupCode);
            setProductName(found ? found.name : '');
          } else {
            const found = products.find(p => p.barcode === barcode);
            setProductName(found ? found.name : '');
          }
        }, [barcode, products, storeProfile.instorePrefixes, storeProfile.instoreItemCodeLength]);

        // --- Handlers ---
        const handleScan = (code) => {
          if (scannerTarget === 'main') {
            setBarcode(code);
          } else if (scannerTarget === 'db') {
            setNewProductBarcode(code);
          }
          setScannerTarget(null);
          const audio = new Audio('https://www.soundjay.com/buttons/beep-01a.mp3');
          audio.play().catch(e => console.log('Audio play failed', e));
        };

        const handleSelectNoJanProduct = (prod) => {
          setBarcode(prod.barcode);
          setProductName(prod.name);
          setShowNoJanModal(false);
        };

        const handleAddRecord = (e) => {
          e.preventDefault();
          if (!price || !quantity) return;

          const numPrice = parseInt(price, 10);
          const numQty = parseInt(quantity, 10);
          const numMarkdown = markdownPrice ? parseInt(markdownPrice, 10) : undefined;

          if (isNaN(numPrice) || isNaN(numQty)) return;

          const [y, m, d] = inputDate.split('-').map(Number);
          const now = new Date();
          const timestamp = new Date(y, m - 1, d, now.getHours(), now.getMinutes(), now.getSeconds()).getTime();

          const generateId = () => {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
              return crypto.randomUUID();
            }
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
          };

          const newRecord = {
            id: generateId(),
            barcode,
            productName,
            originalPrice: numPrice,
            quantity: numQty,
            type,
            markdownPrice: type === RecordType.MARKDOWN ? numMarkdown : undefined,
            timestamp: timestamp,
            dateStr: new Date(timestamp).toISOString()
          };

          setRecords(prev => [newRecord, ...prev]);

          // Update Product DB if not instore
          if (barcode && productName) {
             const prefixes = storeProfile.instorePrefixes 
               ? storeProfile.instorePrefixes.split(',').map(s => s.trim()).filter(s => s !== '')
               : [];
             const cLen = storeProfile.instoreItemCodeLength || 5;
             const instore = parseInstoreCode(barcode, prefixes, cLen);
             
             if (!instore) {
               const existingIndex = products.findIndex(p => p.barcode === barcode);
               if (existingIndex === -1) {
                 setProducts(prev => [...prev, { barcode, name: productName }]);
               } else if (products[existingIndex].name !== productName) {
                  const newProducts = [...products];
                  newProducts[existingIndex].name = productName;
                  setProducts(newProducts);
               }
             }
          }

          setBarcode('');
          setProductName('');
          setPrice('');
          setMarkdownPrice('');
          setQuantity('1');
          alert('登録しました');
        };

        const handleDelete = (id, e) => {
          e.preventDefault();
          e.stopPropagation();
          setDeleteConfirm({ show: true, type: 'record', id });
        };

        const handleBackup = () => {
          const data = {
            version: 2,
            storeProfile,
            records,
            products
          };
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `loss_backup_${new Date().toISOString().slice(0, 10)}.json`;
          a.click();
          URL.revokeObjectURL(url);
        };

        const handleRestore = (e) => {
          const file = e.target.files?.[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const json = JSON.parse(event.target?.result);
              if (json && typeof json === 'object') {
                 setRestoreConfirm({ show: true, data: json });
              } else {
                alert('不正なバックアップファイルです');
              }
            } catch (err) {
              alert('読み込みエラーが発生しました');
            }
          };
          reader.readAsText(file);
          e.target.value = '';
        };

        const performRestore = () => {
          const data = restoreConfirm.data;
          if (data) {
              if (data.records) setRecords(data.records);
              if (data.storeProfile) setStoreProfile(prev => ({ ...prev, ...data.storeProfile }));
              if (data.products) setProducts(data.products);
              alert('復元完了しました');
          }
          setRestoreConfirm({ show: false, data: null });
        };

        const handleExportCSV = () => {
          const targetMonth = viewMonth || getFiscalMonthLabel(new Date());
          const monthRecords = filterRecordsByFiscalMonth(records, targetMonth);
          
          if (monthRecords.length === 0) {
            alert('表示中の月度のデータがありません');
            return false;
          }

          const wasteRecords = monthRecords.filter(r => r.type === RecordType.WASTE);
          const markdownRecords = monthRecords.filter(r => r.type === RecordType.MARKDOWN);

          const formatDate = (ts) => new Date(ts).toLocaleString('ja-JP');
          const sanitize = (str) => `"${str.replace(/"/g, '""')}"`;
          
          // Waste Section
          let wasteContent = "【廃棄集計】\n";
          wasteContent += "日付,JANコード,商品名,原単価,数量,廃棄額\n";
          let wasteTotal = 0;
          const wasteDaily = {};

          wasteRecords.forEach(r => {
            const amount = r.originalPrice * r.quantity;
            wasteTotal += amount;
            const dateKey = new Date(r.timestamp).toLocaleDateString('ja-JP');
            wasteDaily[dateKey] = (wasteDaily[dateKey] || 0) + amount;
            wasteContent += [
              sanitize(formatDate(r.timestamp)),
              sanitize(r.barcode),
              sanitize(r.productName),
              r.originalPrice,
              r.quantity,
              amount
            ].join(',') + "\n";
          });

          wasteContent += "\n[廃棄・日別集計]\n日付,廃棄額計\n";
          Object.keys(wasteDaily).sort().forEach(date => {
             wasteContent += `${date},${wasteDaily[date]}\n`;
          });
          wasteContent += `\n[廃棄・月間合計]\n${targetMonth},${wasteTotal}\n`;

          // Markdown Section
          let markdownContent = "\n\n【見切り集計】\n";
          markdownContent += "日付,JANコード,商品名,原単価,見切単価,数量,見切額\n";
          let markdownTotal = 0;
          const markdownDaily = {};

          markdownRecords.forEach(r => {
            const amount = (r.originalPrice - (r.markdownPrice || 0)) * r.quantity;
            markdownTotal += amount;
            const dateKey = new Date(r.timestamp).toLocaleDateString('ja-JP');
            markdownDaily[dateKey] = (markdownDaily[dateKey] || 0) + amount;
            markdownContent += [
              sanitize(formatDate(r.timestamp)),
              sanitize(r.barcode),
              sanitize(r.productName),
              r.originalPrice,
              r.markdownPrice || 0,
              r.quantity,
              amount
            ].join(',') + "\n";
          });

          markdownContent += "\n[見切り・日別集計]\n日付,見切額計\n";
          Object.keys(markdownDaily).sort().forEach(date => {
             markdownContent += `${date},${markdownDaily[date]}\n`;
          });
          markdownContent += `\n[見切り・月間合計]\n${targetMonth},${markdownTotal}\n`;

          const fullContent = `店舗名,${sanitize(storeProfile.storeName)},店舗番号,${sanitize(storeProfile.storeNumber)},部門番号,${sanitize(storeProfile.departmentNumber || '')}\n対象月度,${targetMonth}\n\n` 
                              + wasteContent + markdownContent;

          const filename = `${storeProfile.storeName}${storeProfile.storeNumber}${storeProfile.departmentNumber || ''}${targetMonth}ロス集計.csv`;
          downloadCSV(fullContent, filename);
          return true;
        };

        const handleResetRequest = () => {
          const targetMonth = viewMonth || getFiscalMonthLabel(new Date());
          const monthRecords = filterRecordsByFiscalMonth(records, targetMonth);
          if (monthRecords.length === 0) {
            alert('リセットするデータがありません');
            return;
          }
          setResetConfirm(true);
        };

        const performReset = () => {
          const exported = handleExportCSV();
          if (!exported) {
            setResetConfirm(false);
            return;
          }
          const targetMonth = viewMonth || getFiscalMonthLabel(new Date());
          setRecords(prev => prev.filter(r => getFiscalMonthLabel(new Date(r.timestamp)) !== targetMonth));
          setResetConfirm(false);
          setTimeout(() => {
             alert('集計データをCSV出力し、リセットしました');
          }, 500);
        };

        const handleAddProduct = () => {
          if (!newProductBarcode || !newProductName) return;
          setProducts(prev => {
            const filtered = prev.filter(p => p.barcode !== newProductBarcode);
            return [{ barcode: newProductBarcode, name: newProductName }, ...filtered];
          });
          setNewProductBarcode('');
          setNewProductName('');
          alert('商品を登録しました');
        };

        const handleDeleteProduct = (barcode, e) => {
          e.preventDefault();
          e.stopPropagation();
          setDeleteConfirm({ show: true, type: 'product', id: barcode });
        };

        const handleImportProductCSV = (e) => {
          const file = e.target.files?.[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (event) => {
            const buffer = event.target?.result;
            if (!buffer) return;

            let text = '';
            try {
              const decoder = new TextDecoder('utf-8', { fatal: true });
              text = decoder.decode(buffer);
            } catch (err) {
              try {
                 const decoder = new TextDecoder('shift-jis');
                 text = decoder.decode(buffer);
              } catch (sjisErr) {
                 alert('ファイルの読み込みに失敗しました。対応していない文字コードの可能性があります。');
                 return;
              }
            }
            
            const lines = text.split(/\r\n|\n|\r/);
            const newProducts = [];
            
            lines.forEach(line => {
              const parts = line.split(',');
              if (parts.length >= 2) {
                const rawBarcode = parts[0].trim().replace(/"/g, '');
                const rawName = parts[1].trim().replace(/"/g, '');
                if (rawBarcode && rawName && /^\d+$/.test(rawBarcode)) {
                   newProducts.push({ barcode: rawBarcode, name: rawName });
                }
              }
            });

            if (newProducts.length > 0) {
              setImportConfirm({ show: true, products: newProducts });
            } else {
              alert('有効なデータが見つかりませんでした');
            }
          };
          reader.readAsArrayBuffer(file); 
          e.target.value = '';
        };

        const performImport = () => {
          const newProducts = importConfirm.products;
          setProducts(prev => {
            const map = new Map(prev.map(p => [p.barcode, p.name]));
            newProducts.forEach(p => map.set(p.barcode, p.name));
            return Array.from(map.entries()).map(([barcode, name]) => ({ barcode, name }));
          });
          setImportConfirm({ show: false, products: [] });
          alert('読み込み完了');
        };

        const performDelete = () => {
          if (deleteConfirm.type === 'record') {
            setRecords(prev => prev.filter(r => r.id !== deleteConfirm.id));
          } else if (deleteConfirm.type === 'product') {
            setProducts(prev => prev.filter(p => p.barcode !== deleteConfirm.id));
          }
          setDeleteConfirm({ show: false, type: null, id: '' });
        };

        const filteredProducts = products.filter(p => 
          p.name.includes(dbSearch) || p.barcode.includes(dbSearch)
        );
        
        const noJanProducts = products.filter(p => p.barcode.length === 3);

        const availableMonths = useMemo(() => {
          const set = new Set();
          set.add(getFiscalMonthLabel(new Date())); 
          records.forEach(r => set.add(getFiscalMonthLabel(new Date(r.timestamp))));
          
          const list = Array.from(set);
          const parseLabel = (l) => {
             const m = l.match(/(\d+)年(\d+)月度/);
             if (!m) return 0;
             return parseInt(m[1]) * 100 + parseInt(m[2]);
          };

          return list.sort((a, b) => parseLabel(b) - parseLabel(a));
        }, [records]);

        useEffect(() => {
          if (availableMonths.length > 0 && !availableMonths.includes(viewMonth)) {
              setViewMonth(availableMonths[0]);
          } else if (!viewMonth && availableMonths.length > 0) {
            setViewMonth(availableMonths[0]);
          }
        }, [availableMonths, viewMonth]);

        const handlePrevMonth = () => {
          const idx = availableMonths.indexOf(viewMonth);
          if (idx < availableMonths.length - 1) {
            setViewMonth(availableMonths[idx + 1]);
          }
        };

        const handleNextMonth = () => {
          const idx = availableMonths.indexOf(viewMonth);
          if (idx > 0) {
            setViewMonth(availableMonths[idx - 1]);
          }
        };

        const reportData = useMemo(() => {
          if (!viewMonth) return null;
          const targetRecords = filterRecordsByFiscalMonth(records, viewMonth);
          const data = { waste: 0, markdown: 0, total: 0, days: {} };

          targetRecords.forEach(r => {
             const dateObj = new Date(r.timestamp);
             const dayLabel = `${dateObj.getFullYear()}/${dateObj.getMonth() + 1}/${dateObj.getDate()}`;

             if (!data.days[dayLabel]) {
               data.days[dayLabel] = { waste: 0, markdown: 0, total: 0, records: [] };
             }

             let amount = 0;
             if (r.type === RecordType.WASTE) {
               amount = r.originalPrice * r.quantity;
               data.waste += amount;
               data.days[dayLabel].waste += amount;
             } else {
               amount = (r.originalPrice - (r.markdownPrice || 0)) * r.quantity;
               data.markdown += amount;
               data.days[dayLabel].markdown += amount;
             }
             
             data.total += amount;
             data.days[dayLabel].total += amount;
             data.days[dayLabel].records.push(r);
          });
          return data;
        }, [records, viewMonth]);

        const cLen = storeProfile.instoreItemCodeLength || 5;
        const pLen = 10 - cLen;
        const dbInstruction = `価格(${pLen}桁)とCD(1桁)を0にした13桁（例: 20...000000）で登録してください。`;

        return (
          <div className="min-h-screen bg-gray-100 flex flex-col pb-24">
            {/* Header */}
            <header className="bg-brand-600 text-white p-3 shadow-md sticky top-0 z-10">
              <div className="flex justify-between items-center max-w-4xl mx-auto">
                <h1 className="text-lg font-bold flex items-center gap-2">
                  <TrendingUp size={20} />
                  ロスチェッカー
                </h1>
              </div>
            </header>

            <main className="flex-1 p-3 max-w-4xl mx-auto w-full overflow-y-auto pb-safe">
              {scannerTarget && <Scanner onDetected={handleScan} onClose={() => setScannerTarget(null)} />}
              
              {/* DELETE MODAL */}
              {deleteConfirm.show && (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 p-4">
                  <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-xs text-center animate-in fade-in zoom-in-95 duration-200">
                    <div className="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                      <Trash2 size={24} />
                    </div>
                    <h3 className="font-bold text-lg text-gray-800 mb-2">削除確認</h3>
                    <p className="text-gray-600 mb-6 text-sm">
                      {deleteConfirm.type === 'record' 
                        ? 'このロスデータを削除してもよろしいですか？' 
                        : 'この商品をデータベースから削除してもよろしいですか？'}
                    </p>
                    <div className="flex gap-3">
                      <button onClick={() => setDeleteConfirm({ show: false, type: null, id: '' })} className="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-bold transition-colors">
                        キャンセル
                      </button>
                      <button onClick={performDelete} className="flex-1 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold shadow-md transition-colors">
                        削除する
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* RESET MODAL */}
              {resetConfirm && (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 p-4">
                  <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-xs text-center animate-in fade-in zoom-in-95 duration-200">
                    <div className="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                      <RotateCcw size={24} />
                    </div>
                    <h3 className="font-bold text-lg text-gray-800 mb-2">集計リセット確認</h3>
                    <p className="text-gray-600 mb-6 text-sm">
                      CSVをダウンロードした後、<br/>
                      <span className="font-bold">{viewMonth}</span> のデータを全て削除します。<br/>
                      よろしいですか？
                    </p>
                    <div className="flex gap-3">
                      <button onClick={() => setResetConfirm(false)} className="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-bold transition-colors">
                        キャンセル
                      </button>
                      <button onClick={performReset} className="flex-1 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold shadow-md transition-colors text-xs">
                        保存してリセット
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* IMPORT MODAL */}
              {importConfirm.show && (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 p-4">
                  <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-xs text-center animate-in fade-in zoom-in-95 duration-200">
                    <div className="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                      <Upload size={24} />
                    </div>
                    <h3 className="font-bold text-lg text-gray-800 mb-2">インポート確認</h3>
                    <p className="text-gray-600 mb-6 text-sm">
                      {importConfirm.products.length}件の商品を読み込みますか？<br/>
                      <span className="text-xs text-red-500">※既存のJANコードは上書きされます</span>
                    </p>
                    <div className="flex gap-3">
                      <button onClick={() => setImportConfirm({ show: false, products: [] })} className="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-bold transition-colors">
                        キャンセル
                      </button>
                      <button onClick={performImport} className="flex-1 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold shadow-md transition-colors">
                        読み込む
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* RESTORE MODAL */}
              {restoreConfirm.show && (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 p-4">
                  <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-xs text-center animate-in fade-in zoom-in-95 duration-200">
                    <div className="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                      <FileJson size={24} />
                    </div>
                    <h3 className="font-bold text-lg text-gray-800 mb-2">復元の確認</h3>
                    <p className="text-gray-600 mb-6 text-sm">
                      現在のデータを上書きしてバックアップを復元しますか？<br/>
                      <span className="text-xs text-red-500">※この操作は取り消せません</span>
                    </p>
                    <div className="flex gap-3">
                      <button onClick={() => setRestoreConfirm({ show: false, data: null })} className="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-bold transition-colors">
                        キャンセル
                      </button>
                      <button onClick={performRestore} className="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-md transition-colors">
                        復元する
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* NO JAN MODAL */}
              {showNoJanModal && (
                <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
                  <div className="bg-white rounded-xl w-full max-w-md shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
                     <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                       <h3 className="font-bold text-lg text-gray-800">JANコードがない商品を選択</h3>
                       <button onClick={() => setShowNoJanModal(false)} className="p-2 hover:bg-gray-200 rounded-full">
                         <X size={20} />
                       </button>
                     </div>
                     <div className="overflow-y-auto p-2">
                       {noJanProducts.length === 0 ? (
                         <div className="p-8 text-center text-gray-500">
                           <div>3桁コードの商品が見つかりません</div>
                           <div className="text-xs mt-2">商品DBに3桁の仮コードで登録してください</div>
                         </div>
                       ) : (
                         <div className="grid grid-cols-1 divide-y">
                           {noJanProducts.map(p => (
                             <button key={p.barcode} onClick={() => handleSelectNoJanProduct(p)} className="flex justify-between items-center p-4 hover:bg-brand-50 text-left transition-colors">
                               <span className="font-bold text-gray-800">{p.name}</span>
                               <span className="text-xs font-mono bg-gray-100 px-2 py-1 rounded text-gray-500">{p.barcode}</span>
                             </button>
                           ))}
                         </div>
                       )}
                     </div>
                  </div>
                </div>
              )}

              {/* --- INPUT TAB --- */}
              {activeTab === 'input' && (
                <div className="bg-white p-3 rounded-xl shadow-sm border border-gray-200">
                  <h2 className="text-base font-bold mb-2 text-gray-700 border-b pb-1">商品登録</h2>
                  <form onSubmit={handleAddRecord} className="space-y-2">
                    
                    {/* Row 1: Date & No JAN Button */}
                    <div className="flex gap-2 items-end">
                      <div className="w-1/2">
                          <label className="block text-xs font-medium text-gray-600 mb-0.5">登録日</label>
                          <input 
                            type="date"
                            required
                            value={inputDate}
                            onChange={(e) => setInputDate(e.target.value)}
                            className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-brand-500 outline-none text-sm bg-gray-50 font-bold"
                          />
                      </div>
                      <button
                        type="button"
                        onClick={() => setShowNoJanModal(true)}
                        className="flex-1 h-[38px] bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-xs font-bold flex items-center justify-center gap-1 border border-gray-300"
                      >
                        <List size={14} /> JANなし商品
                      </button>
                    </div>

                    {/* Barcode */}
                    <div>
                      <label className="block text-xs font-medium text-gray-600 mb-0.5">JANコード</label>
                      <div className="flex gap-2">
                        <input 
                          type="number" 
                          value={barcode}
                          onChange={(e) => setBarcode(e.target.value)}
                          placeholder="スキャンまたは入力"
                          className="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-brand-500 outline-none font-mono text-base"
                        />
                        <button 
                          type="button"
                          onClick={() => setScannerTarget('main')}
                          className="bg-gray-800 text-white p-2 rounded-lg hover:bg-gray-700 flex flex-col items-center justify-center min-w-[50px]"
                        >
                          <Camera size={20} />
                          <span className="text-[9px] font-bold">起動</span>
                        </button>
                      </div>
                    </div>

                     {/* Product Name */}
                     <div>
                      <label className="block text-xs font-medium text-gray-600 mb-0.5">商品名</label>
                      <input 
                        type="text" 
                        value={productName}
                        onChange={(e) => setProductName(e.target.value)}
                        placeholder="商品名 (自動入力または手動)"
                        className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-brand-500 outline-none text-sm"
                      />
                    </div>

                    {/* Type Selection */}
                    <div className="grid grid-cols-2 gap-3">
                      <button
                        type="button"
                        onClick={() => setType(RecordType.WASTE)}
                        className={`p-2 rounded-lg border-2 font-bold text-base transition-colors ${
                          type === RecordType.WASTE 
                            ? 'border-red-500 bg-red-50 text-red-600' 
                            : 'border-gray-200 text-gray-400'
                        }`}
                      >
                        廃棄
                      </button>
                      <button
                        type="button"
                        onClick={() => setType(RecordType.MARKDOWN)}
                        className={`p-2 rounded-lg border-2 font-bold text-base transition-colors ${
                          type === RecordType.MARKDOWN 
                            ? 'border-green-500 bg-green-50 text-green-600' 
                            : 'border-gray-200 text-gray-400'
                        }`}
                      >
                        見切り
                      </button>
                    </div>

                    {/* Price */}
                    <div>
                      <label className="block text-xs font-medium text-gray-600 mb-0.5">売価 (税込)</label>
                      <input 
                        type="number" 
                        required
                        value={price}
                        onChange={(e) => setPrice(e.target.value)}
                        className="w-full p-4 border rounded-lg text-2xl font-bold text-right pr-4"
                        placeholder="例: 198"
                      />
                    </div>

                    {/* Markdown Price (Conditional) */}
                    {type === RecordType.MARKDOWN && (
                      <div className="animate-in fade-in slide-in-from-top-2 duration-300">
                        <label className="block text-xs font-medium text-green-700 mb-0.5">値下げ後売価</label>
                        <input 
                          type="number" 
                          required
                          value={markdownPrice}
                          onChange={(e) => setMarkdownPrice(e.target.value)}
                          className="w-full p-2 border-2 border-green-200 rounded-lg text-base font-semibold bg-green-50"
                          placeholder="例: 100"
                        />
                      </div>
                    )}

                    {/* Quantity */}
                    <div>
                      <label className="block text-xs font-medium text-gray-600 mb-0.5">数量</label>
                      <div className="flex items-center gap-3">
                        <button type="button" onClick={() => setQuantity(String(Math.max(1, parseInt(quantity||'0') - 1)))} className="w-10 h-10 bg-gray-200 rounded-lg text-lg font-bold">-</button>
                        <input 
                          type="number" 
                          required
                          value={quantity}
                          onChange={(e) => setQuantity(e.target.value)}
                          className="flex-1 p-2 border rounded-lg text-center text-lg font-bold"
                        />
                        <button type="button" onClick={() => setQuantity(String(parseInt(quantity||'0') + 1))} className="w-10 h-10 bg-gray-200 rounded-lg text-lg font-bold">+</button>
                      </div>
                    </div>

                    {/* Submit */}
                    <button type="submit" className="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3 rounded-xl shadow-lg transform transition active:scale-95 text-base mt-2">
                      取り込み (保存)
                    </button>

                  </form>
                </div>
              )}

              {/* --- DATABASE TAB --- */}
              {activeTab === 'database' && (
                <div className="space-y-6">
                   <div className="flex justify-between items-center">
                    <h2 className="text-xl font-bold text-gray-800">商品データベース</h2>
                    <div className="relative">
                      <input type="file" accept=".csv" onChange={handleImportProductCSV} id="csv-upload" className="hidden" />
                      <label htmlFor="csv-upload" className="flex items-center gap-1 bg-green-600 text-white px-3 py-2 rounded text-sm font-bold cursor-pointer hover:bg-green-700">
                        <Upload size={16} /> CSV読込
                      </label>
                    </div>
                  </div>

                  <div className="bg-blue-50 p-3 rounded-lg flex items-start gap-2 border border-blue-100">
                     <Info size={16} className="text-blue-600 mt-0.5 shrink-0" />
                     <div className="text-xs text-blue-800">
                       <strong>インストアコード商品の登録</strong><br/>
                       {dbInstruction}
                     </div>
                  </div>

                  <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                     <h3 className="font-bold text-gray-700 mb-2 text-sm">新規登録 / 更新</h3>
                     <div className="flex flex-col gap-2">
                        <div className="flex gap-2">
                          <input type="text" placeholder="JANコード (3桁の場合は仮コード)" value={newProductBarcode} onChange={(e) => setNewProductBarcode(e.target.value)} className="border p-2 rounded flex-1" />
                          <button type="button" onClick={() => setScannerTarget('db')} className="bg-gray-800 text-white p-2 rounded hover:bg-gray-700 flex items-center justify-center w-10">
                            <Camera size={20} />
                          </button>
                        </div>
                         <input type="text" placeholder="商品名" value={newProductName} onChange={(e) => setNewProductName(e.target.value)} className="border p-2 rounded" />
                        <button type="button" onClick={handleAddProduct} className="bg-brand-600 text-white p-2 rounded font-bold flex items-center justify-center gap-2">
                          <Plus size={18} /> 登録
                        </button>
                     </div>
                  </div>

                  <div className="relative">
                    <Search className="absolute left-3 top-3 text-gray-400" size={20} />
                    <input type="text" placeholder="JANコードまたは商品名で検索" value={dbSearch} onChange={(e) => setDbSearch(e.target.value)} className="w-full p-3 pl-10 border rounded-lg" />
                  </div>

                  <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                    {filteredProducts.length === 0 ? (
                       <div className="p-8 text-center text-gray-500">
                          登録された商品がありません
                       </div>
                    ) : (
                      <div className="divide-y max-h-[500px] overflow-y-auto">
                         {filteredProducts.map((product) => (
                           <div key={product.barcode} className="p-4 flex justify-between items-center hover:bg-gray-50">
                              <div>
                                <div className="font-bold text-gray-800">{product.name}</div>
                                <div className="text-sm font-mono text-gray-500">{product.barcode}</div>
                              </div>
                              <button type="button" onClick={(e) => handleDeleteProduct(product.barcode, e)} className="text-red-500 hover:text-red-700 p-2 relative z-10 cursor-pointer hover:bg-red-50 rounded">
                                <Trash2 size={16} className="pointer-events-none" />
                              </button>
                           </div>
                         ))}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* --- REPORT TAB --- */}
              {activeTab === 'report' && (
                <div className="space-y-6">
                  <div className="flex justify-between items-center">
                    <h2 className="text-xl font-bold text-gray-800">月間集計 (20日締め)</h2>
                    <div className="flex gap-2">
                      <button onClick={handleResetRequest} className="text-red-600 flex items-center gap-1 font-bold text-sm bg-red-50 px-3 py-2 rounded">
                         <RotateCcw size={16} /> リセット
                      </button>
                      <button onClick={handleExportCSV} className="text-brand-600 flex items-center gap-1 font-bold text-sm bg-brand-50 px-3 py-2 rounded">
                        <Download size={16} /> CSV出力
                      </button>
                    </div>
                  </div>

                  <div className="bg-white rounded-lg shadow-sm border p-2 flex items-center justify-between">
                    <button onClick={handlePrevMonth} disabled={!viewMonth || availableMonths.indexOf(viewMonth) === availableMonths.length - 1} className="p-2 text-gray-600 hover:bg-gray-100 rounded disabled:opacity-30">
                      <ChevronLeft size={24} />
                    </button>
                    <div className="text-lg font-bold text-gray-800">
                       {viewMonth || 'データなし'}
                    </div>
                    <button onClick={handleNextMonth} disabled={!viewMonth || availableMonths.indexOf(viewMonth) === 0} className="p-2 text-gray-600 hover:bg-gray-100 rounded disabled:opacity-30">
                      <ChevronRight size={24} />
                    </button>
                  </div>
                  
                  {!reportData ? (
                     <p className="text-center text-gray-500 py-10">データがありません</p>
                  ) : (
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden mb-6">
                        <div className="bg-gray-50 px-4 py-3 border-b font-bold text-gray-700 flex justify-between items-center">
                          <span className="text-sm">月間合計</span>
                          <span className="text-xl">{formatCurrency(reportData.total)}</span>
                        </div>
                        
                        <div className="p-4 grid grid-cols-2 divide-x border-b">
                          <div className="text-center">
                            <div className="text-sm text-gray-500 mb-1">廃棄額</div>
                            <div className="text-lg font-bold text-red-600">{formatCurrency(reportData.waste)}</div>
                          </div>
                          <div className="text-center">
                            <div className="text-sm text-gray-500 mb-1">見切り額</div>
                            <div className="text-lg font-bold text-green-600">{formatCurrency(reportData.markdown)}</div>
                          </div>
                        </div>

                        <div className="bg-white">
                          {Object.entries(reportData.days)
                             .sort((a, b) => b[0].localeCompare(a[0])) 
                             .map(([date, daily]) => {
                               const wasteRecords = daily.records.filter(r => r.type === RecordType.WASTE);
                               const markdownRecords = daily.records.filter(r => r.type === RecordType.MARKDOWN);

                               return (
                                 <div key={date} className="border-t border-gray-100 last:border-0">
                                   <div className="bg-gray-50 px-4 py-2 flex justify-between items-center">
                                      <span className="font-bold text-gray-700">{date.slice(5)}</span>
                                      <span className="text-sm font-bold text-gray-900">日計: {formatCurrency(daily.total)}</span>
                                   </div>

                                   <div className="p-4 space-y-4">
                                      {wasteRecords.length > 0 && (
                                        <div>
                                          <div className="flex justify-between items-center mb-2 border-b border-red-100 pb-1">
                                             <h5 className="text-sm font-bold text-red-600 flex items-center gap-1">
                                               <Trash2 size={14}/> 廃棄
                                             </h5>
                                             <span className="text-xs font-bold text-red-600">{formatCurrency(daily.waste)}</span>
                                          </div>
                                          <div className="overflow-x-auto">
                                            <table className="w-full text-xs text-left">
                                              <thead className="text-gray-500 bg-red-50">
                                                <tr>
                                                   <th className="p-1 pl-2">JAN / 商品名</th>
                                                   <th className="p-1 text-right">単価</th>
                                                   <th className="p-1 w-10 text-center">数量</th>
                                                   <th className="p-1 w-16 text-right">金額</th>
                                                   <th className="p-1 w-8"></th>
                                                </tr>
                                              </thead>
                                              <tbody className="divide-y divide-gray-100">
                                                 {wasteRecords.map(r => (
                                                   <tr key={r.id}>
                                                     <td className="p-2">
                                                       <div className="font-bold text-gray-700">{r.productName}</div>
                                                       <div className="text-[10px] text-gray-400 font-mono">{r.barcode}</div>
                                                     </td>
                                                     <td className="p-2 text-right">¥{r.originalPrice}</td>
                                                     <td className="p-2 text-center">{r.quantity}</td>
                                                     <td className="p-2 text-right font-medium text-gray-700">
                                                       {formatCurrency(r.originalPrice * r.quantity)}
                                                     </td>
                                                     <td className="p-2 text-center">
                                                       <button type="button" onClick={(e) => handleDelete(r.id, e)} className="text-red-500 hover:text-red-700 p-2 relative z-10 cursor-pointer hover:bg-red-50 rounded">
                                                         <Trash2 size={16} className="pointer-events-none" />
                                                       </button>
                                                     </td>
                                                   </tr>
                                                 ))}
                                              </tbody>
                                            </table>
                                          </div>
                                        </div>
                                      )}

                                      {markdownRecords.length > 0 && (
                                        <div>
                                          <div className="flex justify-between items-center mb-2 border-b border-green-100 pb-1">
                                             <h5 className="text-sm font-bold text-green-600 flex items-center gap-1">
                                               <Tag size={14}/> 見切り
                                             </h5>
                                             <span className="text-xs font-bold text-green-600">{formatCurrency(daily.markdown)}</span>
                                          </div>
                                          <div className="overflow-x-auto">
                                            <table className="w-full text-xs text-left">
                                              <thead className="text-gray-500 bg-green-50">
                                                <tr>
                                                   <th className="p-1 pl-2">JAN / 商品名</th>
                                                   <th className="p-1 text-right">原単価<br/>見切単価</th>
                                                   <th className="p-1 w-10 text-center">数量</th>
                                                   <th className="p-1 w-16 text-right">金額</th>
                                                   <th className="p-1 w-8"></th>
                                                </tr>
                                              </thead>
                                              <tbody className="divide-y divide-gray-100">
                                                 {markdownRecords.map(r => (
                                                   <tr key={r.id}>
                                                     <td className="p-2">
                                                       <div className="font-bold text-gray-700">{r.productName}</div>
                                                       <div className="text-[10px] text-gray-400 font-mono">{r.barcode}</div>
                                                     </td>
                                                     <td className="p-2 text-right">
                                                       <div>¥{r.originalPrice}</div>
                                                       <div className="text-green-600 font-bold">¥{r.markdownPrice}</div>
                                                     </td>
                                                     <td className="p-2 text-center">{r.quantity}</td>
                                                     <td className="p-2 text-right font-medium text-gray-700">
                                                       {formatCurrency((r.originalPrice - (r.markdownPrice || 0)) * r.quantity)}
                                                     </td>
                                                     <td className="p-2 text-center">
                                                       <button type="button" onClick={(e) => handleDelete(r.id, e)} className="text-red-500 hover:text-red-700 p-2 relative z-10 cursor-pointer hover:bg-red-50 rounded">
                                                         <Trash2 size={16} className="pointer-events-none" />
                                                       </button>
                                                     </td>
                                                   </tr>
                                                 ))}
                                              </tbody>
                                            </table>
                                          </div>
                                        </div>
                                      )}
                                   </div>
                                 </div>
                               );
                          })}
                        </div>
                    </div>
                  )}
                </div>
              )}

              {/* --- SETTINGS TAB --- */}
              {activeTab === 'settings' && (
                <div className="space-y-6">
                  <h2 className="text-xl font-bold text-gray-800">設定・データ管理</h2>
                  
                  <div className="bg-white p-6 rounded-xl shadow-sm border space-y-4">
                    <h3 className="font-bold text-gray-700 border-b pb-2">店舗情報</h3>
                    <div>
                      <label className="block text-sm text-gray-600">店舗名</label>
                      <input type="text" value={storeProfile.storeName} onChange={e => setStoreProfile({...storeProfile, storeName: e.target.value})} className="w-full border p-2 rounded" />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600">店舗番号</label>
                      <input type="text" value={storeProfile.storeNumber} onChange={e => setStoreProfile({...storeProfile, storeNumber: e.target.value})} className="w-full border p-2 rounded" />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600">部門番号</label>
                      <input type="text" value={storeProfile.departmentNumber || ''} onChange={e => setStoreProfile({...storeProfile, departmentNumber: e.target.value})} className="w-full border p-2 rounded" />
                    </div>
                  </div>

                  <div className="bg-white p-6 rounded-xl shadow-sm border space-y-4">
                    <h3 className="font-bold text-gray-700 border-b pb-2">インストアコード設定</h3>
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">対象プレフィックス (カンマ区切り)</label>
                      <input type="text" value={storeProfile.instorePrefixes || ''} onChange={e => setStoreProfile({...storeProfile, instorePrefixes: e.target.value})} className="w-full border p-2 rounded" placeholder="例: 20,21,22" />
                    </div>
                    <div>
                       <label className="block text-sm text-gray-600 mb-1">インストアコード構成 (C:商品 / P:価格)</label>
                       <select value={storeProfile.instoreItemCodeLength || 5} onChange={e => setStoreProfile({...storeProfile, instoreItemCodeLength: parseInt(e.target.value)})} className="w-full border p-2 rounded bg-white">
                         <option value={4}>C:4桁 / P:6桁</option>
                         <option value={5}>C:5桁 / P:5桁 (標準)</option>
                         <option value={6}>C:6桁 / P:4桁</option>
                         <option value={7}>C:7桁 / P:3桁</option>
                         <option value={8}>C:8桁 / P:2桁</option>
                       </select>
                    </div>
                    <p className="text-xs text-gray-500 mt-1">
                        13桁のバーコード（FF <span className="font-bold text-gray-700">C...</span> <span className="font-bold text-gray-700">P...</span> D）の構成比率を設定します。<br/>
                        データベース参照時は「FF<span className="font-bold text-gray-700">C...</span>000...」({cLen + 2 + (10 - cLen)}桁 + CD)で検索されます。
                    </p>
                  </div>

                  <div className="bg-white p-6 rounded-xl shadow-sm border space-y-4">
                    <h3 className="font-bold text-gray-700 border-b pb-2">バックアップ・復元</h3>
                    
                    <button onClick={handleBackup} className="w-full flex items-center justify-center gap-2 bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700">
                      <FileJson size={20} /> バックアップを保存
                    </button>

                    <div className="relative border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition-colors">
                      <input type="file" accept=".json" onChange={handleRestore} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                      <div className="pointer-events-none flex flex-col items-center gap-2 text-gray-500">
                        <Upload size={24} />
                        <span className="font-medium">復元データをアップロード</span>
                        <span className="text-xs">(.jsonファイルをタップ)</span>
                      </div>
                    </div>
                    <p className="text-xs text-gray-500 mt-2">※商品データベースもバックアップに含まれます。</p>
                  </div>
                </div>
              )}

            </main>

            <nav className="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-between px-2 py-3 pb-safe z-40 text-[10px] font-medium text-gray-500">
              <button onClick={() => setActiveTab('input')} className={`flex-1 flex flex-col items-center gap-1 ${activeTab === 'input' ? 'text-brand-600' : ''}`}>
                <div className={`p-1 rounded-full ${activeTab === 'input' ? 'bg-brand-50' : ''}`}>
                  <Camera size={20} strokeWidth={activeTab === 'input' ? 2.5 : 2} />
                </div>
                入力
              </button>
              <button onClick={() => setActiveTab('database')} className={`flex-1 flex flex-col items-center gap-1 ${activeTab === 'database' ? 'text-brand-600' : ''}`}>
                <div className={`p-1 rounded-full ${activeTab === 'database' ? 'bg-brand-50' : ''}`}>
                  <Database size={20} strokeWidth={activeTab === 'database' ? 2.5 : 2} />
                </div>
                商品DB
              </button>
              <button onClick={() => setActiveTab('report')} className={`flex-1 flex flex-col items-center gap-1 ${activeTab === 'report' ? 'text-brand-600' : ''}`}>
                 <div className={`p-1 rounded-full ${activeTab === 'report' ? 'bg-brand-50' : ''}`}>
                  <TrendingUp size={20} strokeWidth={activeTab === 'report' ? 2.5 : 2} />
                </div>
                集計
              </button>
              <button onClick={() => setActiveTab('settings')} className={`flex-1 flex flex-col items-center gap-1 ${activeTab === 'settings' ? 'text-brand-600' : ''}`}>
                 <div className={`p-1 rounded-full ${activeTab === 'settings' ? 'bg-brand-50' : ''}`}>
                  <Settings size={20} strokeWidth={activeTab === 'settings' ? 2.5 : 2} />
                </div>
                設定
              </button>
            </nav>
            
            <style>{`
              .pb-safe {
                padding-bottom: env(safe-area-inset-bottom, 20px);
              }
            `}</style>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
